{% extends "template_parts/base.html" %}


{% block content %}

<div class="container-fluid" style="max-width: 1140px;">

	<div class="bg-white p-3 mt-4">
		<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3">
			<h1 class="h2">Blackjack</h1>
		</div>
	</div>

	<div class="row">
		<div class="m-auto col-12 col-md-6" id="input_img_container">
			<h3 class="text-white mt-3">Dealers cards</h3>
			<div class="border border-5 border-white dealer_cards_container my-3 rounded-3 overflow-hidden">
				<img class="dealer_cards" src="{{ url_for('study.get_image', filename=game_id|string + '/' + sample_number|string + '/dealer_cards.jpeg') }}" width="100%">
			</div>
			<h3 class="text-white mt-3">Players cards</h3>
			<div class="border border-5 border-white player_cards_container my-3 rounded-3 overflow-hidden">
				<img class="player_cards" src="{{ url_for('study.get_image', filename=game_id|string + '/' + sample_number|string + '/player_cards.jpeg') }}" width="100%">
			</div>
		</div>
		<div class="col-3">
			<div class="border border-5 border-white rounded-3 mt-3 p-3">
				<h3 class="text-white mb-0">Score: {{total_score}}</h3>
			</div>
		</div>
	</div>

	<div id="ai-prediction" class="">
	</div>
</div>

<main class="col px-md-4">
	<div class="bg-white p-3 mt-4 rounded-3 overflow-hidden">

		<div class="row">

			<div id="ai-prediction" class="bg-white col-12 col-md-7">
				<div class="position-container">
					<div class="container-fluid" style="max-width: 1140px;">
						<div class="row mb-3">
							<div class="col-12">
								<div class="card border-info mb-3">
									<div class="card-header">
									AI suggestion
									</div>
									<div class="card-body">
										<p class="card-text">The AI suggests you should <b id="task-out"></b> because you have a <b id="hard_soft_out">xxx</b> hand with a value of <b id="player_value_out">xxx</b> and the dealer has a card with the value of <b id="dealer_card_out">xxx</b>.</p>
									</div>
								</div>
							</div>
							<div class="col-12">

							</div>
						</div>
					</div>

					<form action="" method="post" class="mb-3 mx-2" autocomplete="off" id="sample-submit-form">
						{{ form.hidden_tag() }}
						<p class="h6">Label the sample</p>
						<div class="mb-3">
							{% for subfield in form.participant_move %}
								<div class="form-check">
									{{ subfield (class_="form-check-input") }}
									{{ subfield.label (class_="form-check-label") }}
								</div>
							{% endfor %}
						</div>
						<p class="h6">Select all that apply
							<button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_ai_use" aria-expanded="false" aria-controls="collapse_ai_use">
								<i class="bi bi-question-circle-fill"></i>
							</button>
						</p>
						<div class="collapse border border-info-subtle p-1 rounded mb-1" id="collapse_ai_use">
							<p><b>I was influenced by the AIâ€™s suggestion</b>: The suggested label the AI provided helped you label the sample.</p>
							<p><b>I was influenced by the concepts the AI detected</b>: The concepts the AI detected helped you label the sample.</p>
							<p><b>I was not influenced by the AI</b>: You labelled the sample without looking at the AI outputs.</p>
						</div>
						{% for error in form.ai_use.errors %}
							<p class="text-danger">{{ error }}</p>
						{% endfor %}
						<div class="mb-3">
							{% for subfield in form.ai_use %}
								<div class="form-check">
									{{ subfield (class_="form-check-input") }}
									{{ subfield.label (class_="form-check-label") }}
								</div>
							{% endfor %}
						</div>
						<div class="">
							<button type="submit" name=submit class="btn btn-primary">Submit</button>
						</div>
					</form>
				</div>
			</div>

			<div class="col-12 col-md-5">

			<h4>AI detected concepts</h4>

			<label for="concept_order" class="form-label">Concept order</label>
			<select class="form-select mb-3" aria-label="concept_order" id="concept_order" onChange="orderConcepts(this.options[this.selectedIndex].value, true)">
				<option selected value="hl">Highest to lowest concept value</option>
				<option value="lh">Lowest to highest concept value</option>
			</select>
			<div class="row" id="all_explanations">
				{% for concept in concept_out %}
					{% set concept_id = concept[0] %}

					<div class="col-12" id="explanation_{{ concept_id }}">
						<div class="card mb-3">
							{% if explanation_version == 0 %}
								<div class="card-body">
									<div class="d-flex justify-content-between">
										<p class="card-text mb-0">{{ concept[3] }}</p>
										<button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDesc_{{ concept_id }}" aria-expanded="false" aria-controls="collapseDesc_{{ concept_id }}">
											<i class="bi bi-question-circle-fill"></i>
										</button>
									</div>
									<div class="collapse border border-info-subtle p-1 rounded mb-2" id="collapseDesc_{{ concept_id }}">
										<p>{{ concept[4] }}</p>
									</div>
									<input type="hidden" id="{{ concept_id }}-initial" value="{{ concept[2]|round(2) }}">
									<div class="d-flex">
										<div>
											<button type="button" class="btn btn-secondary btn-sm" onclick="resetValue({{ concept_id }})" id="{{ concept_id }}-reset" disabled>Reset</button>
										</div>
										<div class="flex-grow-1 mx-2">
											<input type="range" class="form-range align-middle" min="0" max="1" step="0.01" value="{{ concept[2]|round(2) }}" id="{{ concept_id }}" name="{{ concept_id }}" onchange="enableBtn('{{ concept_id }}-reset'); updateValue('{{ concept_id }}'); logUpdate('{{ concept_id }}', '{{ game_id }}', {{ sample_number }}, false);">
										</div>
										<div class="">
											<p class="align-middle"><span class="badge rounded-pill bg-secondary" id="{{ concept_id }}-badge">{{ concept[2]|round(2) }}</span></p>
										</div>
									</div>
								</div>
							{% elif explanation_version == 1 %}
								<div class="row g-0">
									<div class="col-md-4" id="{{ concept_id }}_img_container">
										<img class="img-fluid rounded-start w-100 h-auto" src="{{ url_for('study.get_image', filename=game_id|string + '/' + sample_number|string + '/' + concept[1]|string) }}">
									</div>
									<div class="col-md-8">
										<div class="card-body">
												<div class="d-flex justify-content-between">
													<p class="card-text mb-0">{{ concept[3] }}</p>
													<button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDesc_{{ concept_id }}" aria-expanded="false" aria-controls="collapseDesc_{{ concept_id }}">
														<i class="bi bi-question-circle-fill"></i>
													</button>
												</div>
												<div class="collapse border border-info-subtle p-1 rounded mb-2" id="collapseDesc_{{ concept_id }}">
													<p>{{ concept[4] }}</p>
												</div>
												<input type="hidden" id="{{ concept_id }}-initial" value="{{ concept[2]|round(2) }}">
												<div class="d-flex">
													<div>
														<button type="button" class="btn btn-secondary btn-sm" onclick="resetValue({{ concept_id }})" id="{{ concept_id }}-reset" disabled>Reset</button>
													</div>
													<div class="flex-grow-1 mx-2">
														<input type="range" class="form-range align-middle" min="0" max="1" step="0.01" value="{{ concept[2]|round(2) }}" id="{{ concept_id }}" name="{{ concept_id }}" onchange="enableBtn('{{ concept_id }}-reset'); updateValue('{{ concept_id }}'); logUpdate('{{ concept_id }}', '{{ game_id }}', {{ sample_number }}, false);">
													</div>
													<div>
														<p class="align-middle"><span class="badge rounded-pill bg-secondary" id="{{ concept_id }}-badge">{{ concept[2]|round(2) }}</span></p
													</div>
												</div>
										</div>
									</div>
								</div>
							{% endif %}
						</div>
					</div>

				{% endfor %}
			</div>

		</div>
		</div>

		<br/>

	</div>

</main>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/dist/ort.min.js"></script>
<script type=text/javascript src="{{url_for('static', filename='js/js-image-zoom.js') }}"></script>
<script type="text/javascript">

	var last_recorded_action_time = Date.now();
	const game_id = {{ game_id }};
	const sample_number = {{ sample_number }};

	// reset concept value to initial on button click
	function resetValue(input_id) {
		initial_value = document.getElementById(input_id + "-initial").value;
		document.getElementById(input_id).value = initial_value;
		document.getElementById(input_id + "-reset").disabled = true;
		document.getElementById(input_id + "-badge").innerHTML = initial_value;
		logUpdate(input_id, game_id, sample_number, true);
	};

	// enabe reset button
	function enableBtn(btn_id) {
		document.getElementById(btn_id).disabled = false;
	};

	// update readout for slider value and update concept image
	function updateValue(input_id) {
		new_value = document.getElementById(input_id).value;
		document.getElementById(input_id + "-badge").innerHTML = new_value;
	};

	// log user changes to concept predictions
	async function logUpdate(concept_id, game_id, sample_number, reset_pressed) {

		action_time = Date.now();

		const model_pred = await predict();

		$.ajax({
			type:'POST',
			url:'{{ url_for('study.log_range_update') }}',
			data:{
				type: "range",
				last_action_time: last_recorded_action_time,
				action_time: action_time,
				update_value: document.getElementById(concept_id).value,  // range html object id is the same as the concept id
				concept_id: concept_id,
				game_id: game_id,
				sample_number: sample_number,
				reset_pressed: reset_pressed,
				model_move: model_pred
			}
		});

		last_recorded_action_time = action_time;
	};

	const allExplanaions = document.querySelectorAll('[id^="explanation_"]');

	allExplanaions.forEach(explanation_object => {
		// log whenever concept explanations are visible
		var observer = new IntersectionObserver((entries) => {
			if (entries[0].intersectionRatio >= 0.001) {  // using ratio as without logs are less consistent
				var concept_id = entries[0]['target'].id.split("_")[1] // get concept id
				$.ajax({
					type:'POST',
					url:'{{ url_for('study.log_concept_seen') }}',
					data:{
						type: "concept visible",
						action_time: Date.now(),
						concept_id: concept_id,
						game_id: game_id,
						sample_number: sample_number,
					}
				});
			}
		});

		observer.observe(explanation_object);
	});

	// predict downstrea task from concept values
	async function predict() {
		// load model
		const session = await ort.InferenceSession.create("{{ url_for('study.static', filename=model_name) }}");

		// get concpet values and turn into tensor
		var concept_arr = [];
		{% for concept in concept_out %}
			concept_arr.push(document.getElementById("{{ concept[0] }}").value);
		{% endfor %}
		const concept_vec = new Float32Array(concept_arr);
		const tensorA = new ort.Tensor('float32', concept_vec, [1, 28]);

		// prepare feed for models. Key is the model input name
		const feeds = { "onnx::Gemm_0": tensorA };

		// get downstream task predictions
		const results = await session.run(feeds);

		// Get index of highest value in downsream task predictions
		const task_output = results["7"].data;
		var maxNum = Math.max.apply(null, task_output);
		var task_index = task_output.indexOf(maxNum);

		// update task out prediction displayed
		if (task_index == 0) {
			var model_task_out = "hit"
		} else if (task_index == 1) {
			var model_task_out = "stand"
		} else {
			var model_task_out = "surrender"
		};
		document.getElementById("task-out").innerHTML = model_task_out;

		// update soft/hard hand out
		if (concept_vec[0] > concept_vec[1]) {
			var model_concept_out = "soft"
		} else {
			var model_concept_out = "hard"
		};
		document.getElementById("hard_soft_out").innerHTML = model_concept_out;

		// update player value out
		const player_values = concept_vec.slice(2, 17);
		let i = player_values.indexOf(Math.max(...player_values));
		if (i == 0) {
			var model_concept_out = "21 or over"
		} else if (i == 1) {
			var model_concept_out = "21"
		} else if (i == 2) {
			var model_concept_out = "20"
		} else if (i == 3) {
			var model_concept_out = "19"
		} else if (i == 4) {
			var model_concept_out = "18"
		} else if (i == 5) {
			var model_concept_out = "17"
		} else if (i == 6) {
			var model_concept_out = "16"
		} else if (i == 7) {
			var model_concept_out = "15"
		} else if (i == 8) {
			var model_concept_out = "14"
		} else if (i == 9) {
			var model_concept_out = "13"
		} else if (i == 10) {
			var model_concept_out = "12"
		} else if (i == 11) {
			var model_concept_out = "11"
		} else if (i == 12) {
			var model_concept_out = "10"
		} else if (i == 13) {
			var model_concept_out = "9"
		} else {
			var model_concept_out = "8 or below"
		};
		document.getElementById("player_value_out").innerHTML = model_concept_out;

		// update dealer card out
		const dealer_cards = concept_vec.slice(17, 27);
		i = dealer_cards.indexOf(Math.max(...dealer_cards));
		if (i == 0) {
			var model_concept_out = "2"
		} else if (i == 1) {
			var model_concept_out = "3"
		} else if (i == 2) {
			var model_concept_out = "4"
		} else if (i == 3) {
			var model_concept_out = "5"
		} else if (i == 4) {
			var model_concept_out = "6"
		} else if (i == 5) {
			var model_concept_out = "7"
		} else if (i == 6) {
			var model_concept_out = "8"
		} else if (i == 7) {
			var model_concept_out = "9"
		} else if (i == 8) {
			var model_concept_out = "10"
		} else {
			var model_concept_out = "1 or 11"
		};
		document.getElementById("dealer_card_out").innerHTML = model_concept_out;

		// log model prediction (will only update db on first log)
		$.ajax({
			type:'POST',
			url:'{{ url_for('study.model_prediction') }}',
			data:{
				game_id: game_id,
				sample_number: sample_number,
				model_move: task_index,
			}
		});

		return task_index
	};

	//https://bootstrap-menu.com/detail-fixed-onscroll.html
	//document.addEventListener("DOMContentLoaded", function(){
	//	window.addEventListener('scroll', function() {
	//		if (window.scrollY > 50) {
	//			document.getElementById('ai-prediction').classList.add('fixed-top');
	//		} else {
	//			document.getElementById('ai-prediction').classList.remove('fixed-top');
	//		}
	//	});
	//});

	// reorder concept explanations
	function orderConcepts(orderby, logUpdate) {
		var concept_list = [];
		// add all concepts ids and values to array
		allExplanaions.forEach(explanation_object => {
			concept_list.push([explanation_object.id, document.getElementById(explanation_object.id.split('_')[1]).value])
		});

		// reorder aray
		if (orderby == "lh") {
			concept_list.sort(function(a,b){return a[1].localeCompare(b[1]);});
		} else {  // hl
			concept_list.sort(function(a,b){return a[1].localeCompare(b[1]);}).reverse();
		}

		// add each explanation to the div all_explanations in order of concept_list
		container = document.getElementById("all_explanations")
		concept_list.forEach(explanation => {
			container.appendChild(document.getElementById(explanation[0]))
		});

		if (logUpdate) {
			action_time = Date.now();

			$.ajax({
				type:'POST',
				url:'{{ url_for('study.log_sort_update') }}',
				data:{
					type: "sort",
					action_time: action_time,
					update_value: orderby,
					game_id: game_id,
					sample_number: sample_number,
				}
			});
		};
	};

	{% for concept in concept_out %}
		{% set concept_id = concept[0] %}
		$('#collapseDesc_{{ concept_id }}').on('show.bs.collapse', function () {
			action_time = Date.now();

			$.ajax({
				type:'POST',
				url:'{{ url_for('study.toggle_concept_desc') }}',
				data:{
					type: "concept description show",
					action_time: action_time,
					concept_id: {{ concept_id }},
					game_id: game_id,
					sample_number: sample_number,
				}
			});
		})

		$('#collapseDesc_{{ concept_id }}').on('hidden.bs.collapse', function () {
			action_time = Date.now();

			$.ajax({
				type:'POST',
				url:'{{ url_for('study.toggle_concept_desc') }}',
				data:{
					type: "concept description hide",
					action_time: action_time,
					concept_id: {{ concept_id }},
					game_id: game_id,
					sample_number: sample_number,
				}
			});
		})
	{% endfor %}

	// image zoom
	var imageZoomMainOptions = {
		fillContainer: true,
		offset: {vertical: 0, horizontal: 0},
		zoomPosition: "bottom",
		zoomStyle: "z-index: 999;",
	};

	var imageZoomExplainOptions = {
		fillContainer: true,
		scale: 1.1,
		zoomWidth: 300,
		width: 200,
		height: 200,
		offset: {vertical: 0, horizontal: 0},
		zoomPosition: "bottom",
		zoomStyle: "z-index: 999;",
	};

	//new ImageZoom(document.getElementById("input_img_container"), imageZoomMainOptions);

	{% if explanation_version == 1 %}
		{% for concept in concept_out %}
			new ImageZoom(document.getElementById("{{ concept[0] }}_img_container"), imageZoomExplainOptions);
		{% endfor %}
	{% endif %}

	// run all functions for the inital page load
	window.onload = function() {
		var model_pred = predict();
		orderConcepts("hl", false);

		// clear select form radio and check buttons
		document.getElementById("participant_move-0").checked = false;
		document.getElementById("participant_move-1").checked = false;
		document.getElementById("participant_move-2").checked = false;
		document.getElementById("ai_use-0").checked = false;
		document.getElementById("ai_use-1").checked = false;
		document.getElementById("ai_use-2").checked = false;
	};

</script>

{% endblock %}
